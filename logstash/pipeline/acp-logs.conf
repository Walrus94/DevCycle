input {
  file {
    path => "/var/log/acp/*.log"
    start_position => "beginning"
    codec => "json_lines"
    tags => ["acp", "json"]
  }
}

filter {
  if "acp" in [tags] {
    # Parse timestamp
    date {
      match => [ "@timestamp", "ISO8601" ]
    }

    # Add service tag
    mutate {
      add_tag => [ "acp-service" ]
    }

    # Parse ACP-specific fields
    if [type] == "metric" {
      mutate {
        add_tag => [ "metric" ]
      }

      # Convert metric_value to float
      mutate {
        convert => { "metric_value" => "float" }
      }
    }

    if [type] == "event" {
      mutate {
        add_tag => [ "event" ]
      }

      # Parse severity levels
      if [severity] == "ERROR" or [severity] == "CRITICAL" {
        mutate {
          add_tag => [ "error" ]
        }
      }
    }

    # Add environment and service metadata
    mutate {
      add_field => {
        "environment" => "production"
        "service_name" => "acp"
      }
    }
  }
}

output {
  if "acp" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "acp-logs-%{+YYYY.MM.dd}"
      template_name => "acp-logs"
      template => "/usr/share/logstash/templates/acp-logs-template.json"
      template_overwrite => true
    }
  }
}
