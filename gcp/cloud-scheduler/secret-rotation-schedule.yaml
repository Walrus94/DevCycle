# Cloud Scheduler configuration for automated secret rotation
# This file defines scheduled jobs for rotating different types of secrets

# JWT Secret Key Rotation (every 30 days)
apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  name: jwt-secret-rotation
  namespace: default
spec:
  name: jwt-secret-rotation
  description: "Rotate JWT secret key every 30 days"
  schedule: "0 2 1 * *"  # 2 AM on the 1st of every month
  timeZone: "UTC"
  httpTarget:
    uri: "https://REGION-PROJECT_ID.cloudfunctions.net/rotate-secret"
    httpMethod: "POST"
    headers:
      Content-Type: "application/json"
    body: |
      {
        "secret_id": "jwt-secret-key",
        "environment": "prod",
        "rotation_type": "jwt"
      }
  retryConfig:
    retryCount: 3
    maxRetryDuration: "300s"
    minBackoffDuration: "5s"
    maxBackoffDuration: "60s"
    maxDoublings: 5

---
# Database Password Rotation (every 90 days)
apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  name: database-password-rotation
  namespace: default
spec:
  name: database-password-rotation
  description: "Rotate database password every 90 days"
  schedule: "0 3 1 */3 *"  # 3 AM on the 1st of every 3rd month
  timeZone: "UTC"
  httpTarget:
    uri: "https://REGION-PROJECT_ID.cloudfunctions.net/rotate-secret"
    httpMethod: "POST"
    headers:
      Content-Type: "application/json"
    body: |
      {
        "secret_id": "database-password",
        "environment": "prod",
        "rotation_type": "password"
      }
  retryConfig:
    retryCount: 3
    maxRetryDuration: "300s"
    minBackoffDuration: "5s"
    maxBackoffDuration: "60s"
    maxDoublings: 5

---
# Redis Password Rotation (every 60 days)
apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  name: redis-password-rotation
  namespace: default
spec:
  name: redis-password-rotation
  description: "Rotate Redis password every 60 days"
  schedule: "0 4 1 */2 *"  # 4 AM on the 1st of every 2nd month
  timeZone: "UTC"
  httpTarget:
    uri: "https://REGION-PROJECT_ID.cloudfunctions.net/rotate-secret"
    httpMethod: "POST"
    headers:
      Content-Type: "application/json"
    body: |
      {
        "secret_id": "redis-password",
        "environment": "prod",
        "rotation_type": "password"
      }
  retryConfig:
    retryCount: 3
    maxRetryDuration: "300s"
    minBackoffDuration: "5s"
    maxBackoffDuration: "60s"
    maxDoublings: 5

---
# HuggingFace Token Rotation (every 180 days)
apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  name: huggingface-token-rotation
  namespace: default
spec:
  name: huggingface-token-rotation
  description: "Rotate HuggingFace token every 180 days"
  schedule: "0 5 1 */6 *"  # 5 AM on the 1st of every 6th month
  timeZone: "UTC"
  httpTarget:
    uri: "https://REGION-PROJECT_ID.cloudfunctions.net/rotate-secret"
    httpMethod: "POST"
    headers:
      Content-Type: "application/json"
    body: |
      {
        "secret_id": "huggingface-token",
        "environment": "prod",
        "rotation_type": "token"
      }
  retryConfig:
    retryCount: 3
    maxRetryDuration: "300s"
    minBackoffDuration: "5s"
    maxBackoffDuration: "60s"
    maxDoublings: 5

---
# Secret Validation (daily)
apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  name: secret-validation
  namespace: default
spec:
  name: secret-validation
  description: "Validate all secrets are accessible daily"
  schedule: "0 6 * * *"  # 6 AM every day
  timeZone: "UTC"
  httpTarget:
    uri: "https://REGION-PROJECT_ID.cloudfunctions.net/validate-secrets"
    httpMethod: "POST"
    headers:
      Content-Type: "application/json"
    body: |
      {
        "environment": "prod"
      }
  retryConfig:
    retryCount: 2
    maxRetryDuration: "180s"
    minBackoffDuration: "10s"
    maxBackoffDuration: "30s"
    maxDoublings: 3
